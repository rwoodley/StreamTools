<!DOCTYPE html>
<html style='width: 100%; height: 100%;'>
    <style>
        body { margin: 0 }
        video { display: none }
    </style>
    <body  >
    <video id="video" autoplay style="display:none"></video>

    <script src="r73/three.js"></script>
    <script src="r73/OrbitControls.js"></script>
    <script src="files.js"></script>
    <script src="utils.js"></script>
    <script>
        var _camera, _scene, _renderer, _controls, _video, _videoTexture;
        var _planes;
        function init() {
            _camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);
            _camera.position.z = 0.01;

            _renderer =  new THREE.WebGLRenderer({antialias: true, alpha: true});
            _renderer.setPixelRatio(window.devicePixelRatio);
            _renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(_renderer.domElement);

            _controls = new THREE.OrbitControls( _camera, _renderer.domElement );

            _video = document.getElementById('video');
            var texture = new THREE.VideoTexture(_video);
            texture.minFilter = THREE.LinearFilter;
            texture.magFilter = THREE.LinearFilter;
            texture.format = THREE.RGBFormat;

            var geometry = new THREE.PlaneBufferGeometry(16, 9);
            geometry.scale(5,5,5);
            var material = new THREE.MeshBasicMaterial({ map: texture });

            let sphere = new THREE.SphereGeometry(50, 32, 32);
            material.side = THREE.DoubleSide;
            _scene = new THREE.Scene();
            _scene.add(new THREE.Mesh(sphere, material));

            navigator.mediaDevices.enumerateDevices()
                .then(function (devices) {
                devices.forEach(function (device) {
                    console.log(device.kind + ": |" + device.label +
                    "| id = " + device.deviceId);
                });
                })
                .catch(function (err) {
                console.log(err.name + ": " + err.message);
                });

            navigator.mediaDevices.enumerateDevices().then((devices) => {
                let theta = devices.find(device => device.label.match(/RICOH THETA V/));
                // let theta = devices.find(device => device.label.match(/FaceTime HD Camera/));
                // let theta = devices.find(device => device.label.match(/THETA UVC/));
                console.log("Here 0");
                return theta ? { optional: [{ sourceId: theta.deviceId }] } : null
            }).then((video) => {
                return navigator.mediaDevices.getUserMedia({ video });
            }).then((stream) => {
                    _video.srcObject = stream;
                    _video.play();
                }).catch(function (error) {
                    console.error('Unable to access the camera/webcam.', error);
                });
        }

        function render() {
            requestAnimationFrame( render );
            _renderer.render( _scene, _camera );
        }

        function resize() {
            _camera.aspect = window.innerWidth / window.innerHeight;
            _camera.updateProjectionMatrix();
            _renderer.setSize(window.innerWidth, window.innerHeight);
        }
        window.onresize = resize;
        window.addEventListener('orientationchange', function (e) { setTimeout(resize, 250); });
        init();
        render();
        setTimeout(resize, 500);
    </script>
	</body>
</html>
